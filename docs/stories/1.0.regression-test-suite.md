# Story 1.0: Migrate to Vitest & Create Regression Test Suite

## Status
Approved

## Story
**As a** developer,
**I want** to migrate from deprecated Karma/Jasmine to Vitest and create a comprehensive regression test suite,
**so that** I have a modern, supported testing infrastructure and can verify no features are broken during enhancement implementation.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| AC1 | Karma completely removed from project (packages, config files, angular.json) |
| AC2 | Vitest configured as test runner using `@angular/build:unit-test` builder |
| AC3 | All existing tests migrated to Vitest syntax using refactor schematic |
| AC4 | Unit tests for `MonitorService`: `startMonitoring()`, `stopMonitoring()`, `results$` observable behavior |
| AC5 | Unit tests for `HomePage`: stats calculation (`updateStats()`), chart data binding, theme toggle |
| AC6 | Tests verify ping result processing: ok status, error status, null latency handling |
| AC7 | Tests verify statistics calculation: average, min, max, jitter with exponential smoothing |
| AC8 | Tests verify chart updates with new data points (50-point history limit) |
| AC9 | Tests verify dark/light theme toggle persists to localStorage |
| AC10 | Test coverage report generated with minimum 80% coverage on existing services |
| AC11 | All tests pass with `ng test` |
| AC12 | Tests can run in CI pipeline (`ng test --browsers=chromium`) |
| AC13 | Test execution time < 30 seconds (wall-clock time) |
| AC14 | Documentation in `docs/architecture/` updated to reflect Vitest (remove all Karma/Jasmine references) |

## Tasks / Subtasks

- [ ] Task 1: Remove Karma infrastructure (AC: 1)
  - [ ] 1.1 Delete `karma.conf.js` file
  - [ ] 1.2 Delete `src/test.ts` file (Karma bootstrap)
  - [ ] 1.3 Uninstall Karma packages: `npm uninstall karma karma-chrome-launcher karma-coverage karma-jasmine karma-jasmine-html-reporter jasmine-core jasmine-spec-reporter`
  - [ ] 1.4 Remove `@types/jasmine` from devDependencies
  - [ ] 1.5 Verify no Karma references remain in `package.json`

- [ ] Task 2: Install and configure Vitest (AC: 2)
  - [ ] 2.1 Install Vitest and jsdom: `npm install --save-dev vitest jsdom`
  - [ ] 2.2 Install browser provider for real browser testing: `npm install --save-dev @vitest/browser-playwright`
  - [ ] 2.3 Update `angular.json` test target to use `@angular/build:unit-test` builder
  - [ ] 2.4 Configure browser mode with `"browsers": ["chromium"]` in angular.json
  - [ ] 2.5 Create `vitest.config.ts` with resource limits to prevent CPU/memory exhaustion (see Dev Notes)
  - [ ] 2.6 Verify `ng test` runs without errors (tests may fail, but runner must work)

- [ ] Task 3: Migrate existing tests to Vitest syntax (AC: 3)
  - [ ] 3.1 Run refactor schematic: `ng g @schematics/angular:refactor-jasmine-vitest`
  - [ ] 3.2 Review converted tests for any manual fixes needed
  - [ ] 3.3 Update any `spyOn` calls to `vi.spyOn`
  - [ ] 3.4 Update `jasmine.createSpy` to `vi.fn()`
  - [ ] 3.5 Add explicit Vitest imports where needed: `import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'`

- [ ] Task 4: Fix and expand MonitorService tests (AC: 4, 6)
  - [ ] 4.1 Remove broken `measureLatency` tests (lines 33-67) that call non-existent public method
  - [ ] 4.2 Add test RT-001: Should emit ping results via `results$` observable
  - [ ] 4.3 Add test RT-002: Should maintain maximum 50 results in history
  - [ ] 4.4 Add test RT-003: Should correctly detect Tauri platform
  - [ ] 4.5 Add test RT-004: Should correctly detect Capacitor platform
  - [ ] 4.6 Add test for `stopMonitoring()` properly unsubscribes
  - [ ] 4.7 Add test for error status handling (null latencyMs)
  - [ ] 4.8 Add test for ok status handling (valid latencyMs)

- [ ] Task 5: Expand HomePage tests - Statistics (AC: 5, 7)
  - [ ] 5.1 Add test RT-005: Should calculate average latency correctly
  - [ ] 5.2 Add test RT-006: Should calculate min/max latency correctly
  - [ ] 5.3 Add test RT-007: Should calculate jitter with exponential smoothing
  - [ ] 5.4 Add test RT-008: Should filter error results from statistics
  - [ ] 5.5 Add test for stats reset to zero when no valid results

- [ ] Task 6: Expand HomePage tests - Chart & Theme (AC: 5, 8, 9)
  - [ ] 6.1 Add test RT-009: Should update chart data on new results
  - [ ] 6.2 Add test for chart labels match result timestamps
  - [ ] 6.3 Add test for chart handles null latency (maps to 0)
  - [ ] 6.4 Add test RT-010: Should toggle theme and persist to localStorage
  - [ ] 6.5 Add test RT-011: Should apply `ion-palette-dark` class for dark theme
  - [ ] 6.6 Add test RT-012: Should load theme preference on init
  - [ ] 6.7 Add test for system preference listener cleanup on destroy

- [ ] Task 7: Update repository documentation (AC: 14)
  - [ ] 7.1 Update `docs/architecture/testing-strategy.md`: Replace Karma/Jasmine with Vitest
  - [ ] 7.2 Update `docs/architecture/coding-standards.md`: Update testing conventions for Vitest
  - [ ] 7.3 Update `docs/architecture/high-level-architecture.md`: Update test framework references
  - [ ] 7.4 Update `docs/architecture/appendix-useful-commands.md`: Update test commands
  - [ ] 7.5 Search and replace any remaining "Karma" or "Jasmine" references in `docs/`
  - [ ] 7.6 Add Vitest version to technology stack documentation

- [ ] Task 8: Verify coverage and CI compliance (AC: 10, 11, 12, 13)
  - [ ] 8.1 Run full test suite with coverage: `ng test --coverage`
  - [ ] 8.2 Verify 80% coverage on `monitor.service.ts`
  - [ ] 8.3 Verify 80% coverage on `home.page.ts`
  - [ ] 8.4 Verify all tests pass (AC11)
  - [ ] 8.5 Verify browser mode works: `ng test --browsers=chromium`
  - [ ] 8.6 Verify test execution time < 30 seconds wall-clock (AC13)

## Dev Notes

### Source Tree Reference
[Source: architecture/source-tree-and-module-organization.md]

Files to test:
- `netmonitor/src/app/services/monitor.service.ts` - Core monitoring logic
- `netmonitor/src/app/home/home.page.ts` - Monitor page UI + logic

Test files to migrate and expand:
- `netmonitor/src/app/services/monitor.service.spec.ts`
- `netmonitor/src/app/home/home.page.spec.ts`

Files to delete:
- `netmonitor/karma.conf.js`
- `netmonitor/src/test.ts`

Files to create:
- `netmonitor/vitest.config.ts` - Resource limits configuration (see Vitest Resource Configuration section)

### Vitest Migration Commands
[Source: angular.dev/guide/testing/migrating-to-vitest]

```bash
# Remove Karma
npm uninstall karma karma-chrome-launcher karma-coverage karma-jasmine karma-jasmine-html-reporter jasmine-core jasmine-spec-reporter
rm karma.conf.js src/test.ts

# Install Vitest
npm install --save-dev vitest jsdom @vitest/browser-playwright

# Migrate tests (after angular.json is updated)
ng g @schematics/angular:refactor-jasmine-vitest

# Run tests
ng test                      # Default (jsdom)
ng test --browsers=chromium  # Real browser
ng test --coverage           # With coverage report
```

### angular.json Configuration
[Source: angular.dev/guide/testing/migrating-to-vitest]

Update the `test` target in `angular.json`:
```json
{
  "projects": {
    "netmonitor": {
      "architect": {
        "test": {
          "builder": "@angular/build:unit-test",
          "options": {
            "browsers": ["chromium"],
            "runnerConfig": "vitest.config.ts"
          }
        }
      }
    }
  }
}
```

### Vitest Resource Configuration (CRITICAL)
[Source: vitest.dev/guide/improving-performance]

**Problem:** Vitest can spawn many parallel workers and exhaust CPU/memory resources, especially on CI or constrained environments.

**Solution:** Create `netmonitor/vitest.config.ts` with resource limits:

```typescript
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    // Limit parallel workers to prevent resource exhaustion
    maxWorkers: 2,                    // Fixed number of workers (adjust based on CI/local needs)
    minWorkers: 1,                    // Minimum workers to keep alive

    // Use 'forks' pool for better process isolation and cleanup
    pool: 'forks',

    // Disable file-level parallelism for more predictable resource usage
    fileParallelism: false,

    // Optional: Disable isolation for faster tests (only if tests don't have side effects)
    // isolate: false,
  },
})
```

**Configuration Options Explained:**

| Option | Value | Purpose |
|--------|-------|---------|
| `maxWorkers` | `2` or `'50%'` | Limits concurrent worker processes |
| `minWorkers` | `1` | Keeps minimum workers alive to reduce spawn overhead |
| `pool` | `'forks'` | Uses process forks instead of threads for better cleanup |
| `fileParallelism` | `false` | Runs test files sequentially, reducing memory spikes |

**For CI environments**, you may want stricter limits:
```typescript
// vitest.config.ts for CI
export default defineConfig({
  test: {
    maxWorkers: 1,           // Single worker for predictable CI
    fileParallelism: false,
    pool: 'forks',
  },
})
```

### MonitorService Implementation Details
[Source: monitor.service.ts]

Key methods to test:
- `startMonitoring(intervalMs: number)` - Starts polling timer, emits results to `_results$`
- `stopMonitoring()` - Unsubscribes polling, sets subscription to null
- `measureLatency()` - **Private method**, test behavior via `results$` observable
- `results$` - Public observable from BehaviorSubject, keeps last 50 results

Platform detection:
- `isTauri()` - Checks `window.__TAURI__`
- `Capacitor.isNativePlatform()` - Checks Capacitor native

Result structure (`PingResult`):
```typescript
interface PingResult {
  latencyMs: number | null;
  timestamp: Date;
  status: 'ok' | 'error';
}
```

### HomePage Implementation Details
[Source: home.page.ts]

Key methods to test:
- `updateStats(results)` - Calculates current, avg, min, max, jitter from valid results
- `calculateJitter(latencies)` - Exponential smoothing: `jitter += (diff - jitter) / 16.0`
- `updateChart(results)` - Updates `lineChartData.labels` and `datasets[0].data`
- `toggleTheme()` - Toggles `isDark`, saves to localStorage key `netmonitor-theme`
- `setTheme(isDark)` - Adds/removes `ion-palette-dark` class on `document.body`
- `initializeTheme()` - Loads from localStorage or system preference

Stats calculation (line 169-183):
- Filters results where `status === 'ok'` and `latencyMs !== null`
- `current` = last latency
- `avg` = sum / count
- `min` = Math.min(...)
- `max` = Math.max(...)
- `jitter` = exponential smoothing over differences

Theme localStorage key: `netmonitor-theme` (values: `'dark'` | `'light'`)

### Architecture Patterns
[Source: architecture/architecture-patterns-and-conventions.md]

- Components use `inject()` for DI (not constructor injection)
- Services use `BehaviorSubject` pattern for reactive state
- Theme controlled via CSS class `ion-palette-dark` on `<body>`

### Testing

#### Test File Location
[Source: architecture/source-tree-and-module-organization.md]
- Test files co-located with source: `*.spec.ts`
- `monitor.service.spec.ts` in `services/`
- `home.page.spec.ts` in `home/`

#### Testing Framework (NEW)
- **Test Runner:** Vitest (via `@angular/build:unit-test`)
- **DOM Emulation:** jsdom (default) or real browser via Playwright
- **Assertion Library:** Vitest built-in (`expect`)

#### Test Commands
```bash
ng test                      # Run tests with jsdom
ng test --browsers=chromium  # Run tests in real Chromium browser
ng test --coverage           # Generate coverage report
ng test --watch              # Watch mode (default)
```

#### Vitest Test Structure Pattern
```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { TestBed } from '@angular/core/testing';

describe('ServiceName', () => {
  let service: ServiceName;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(ServiceName);
  });

  it('should be created', () => {
    expect(service).toBeTruthy();
  });
});
```

#### Mocking Patterns (Vitest)
[Source: angular.dev/guide/testing/migrating-to-vitest]

Mock Tauri API:
```typescript
beforeEach(() => {
  (window as any).__TAURI__ = {
    invoke: vi.fn().mockResolvedValue({ success: true, latency: 50 })
  };
});

afterEach(() => {
  delete (window as any).__TAURI__;
});
```

Mock localStorage:
```typescript
beforeEach(() => {
  vi.spyOn(Storage.prototype, 'getItem').mockReturnValue('dark');
  vi.spyOn(Storage.prototype, 'setItem').mockImplementation(() => {});
});

afterEach(() => {
  vi.restoreAllMocks();
});
```

#### Coverage Target
- **Target:** 80% coverage on existing services (`monitor.service.ts`, `home.page.ts`)

#### Test Naming Convention
Use descriptive names explaining expected behavior:
```typescript
it('should calculate average latency excluding error results', () => {});
it('should emit results via results$ observable', () => {});
```

### Vitest vs Jasmine Syntax Reference

| Jasmine | Vitest |
|---------|--------|
| `jasmine.createSpy()` | `vi.fn()` |
| `spyOn(obj, 'method')` | `vi.spyOn(obj, 'method')` |
| `jasmine.objectContaining()` | `expect.objectContaining()` |
| `jasmine.any(Type)` | `expect.any(Type)` |
| `fit()` / `fdescribe()` | `it.only()` / `describe.only()` |
| `xit()` / `xdescribe()` | `it.skip()` / `describe.skip()` |
| `fail()` | `vi.fail()` or `expect.fail()` |
| `.and.returnValue()` | `.mockReturnValue()` |
| `.and.callFake()` | `.mockImplementation()` |
| `.and.resolveTo()` | `.mockResolvedValue()` |
| `.and.rejectWith()` | `.mockRejectedValue()` |

### Documentation Files to Update

| File | Changes Required |
|------|------------------|
| `docs/architecture/testing-strategy.md` | Replace Karma/Jasmine 5.1.x/6.4.x with Vitest |
| `docs/architecture/coding-standards.md` | Update test examples to Vitest syntax |
| `docs/architecture/high-level-architecture.md` | Update test framework in tech stack |
| `docs/architecture/appendix-useful-commands.md` | Update test commands |

### Existing Test Analysis

**monitor.service.spec.ts** - Current state:
- Has basic smoke test
- Has `measureLatency()` tests but they call a **non-existent public method** (it's private)
- These tests WILL FAIL and must be removed/rewritten in Task 4.1
- **Action:** Delete tests on lines 33-67, rewrite to test via `results$` observable

**home.page.spec.ts** - Current state:
- Has component creation test
- Has default stats test
- Has basic stats calculation tests
- Has theme toggle tests
- **Action:** Migrate syntax, expand with RT-005 through RT-012

### Notes

1. **Vitest runs Zone-less** by default in Angular 21. The `fakeAsync` and `tick` utilities from Zone.js testing cannot be used. Use `vi.useFakeTimers()` and `vi.advanceTimersByTime()` instead.

2. The Angular CLI's `refactor-jasmine-vitest` schematic handles most syntax conversions automatically.

3. Browser mode (`--browsers=chromium`) provides real DOM testing when jsdom is insufficient.

4. Coverage is built-in: `ng test --coverage` generates reports without additional plugins.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-10 | 0.1 | Initial draft created | Scrum Master |
| 2025-12-10 | 0.2 | PO validation: merged IVâ†’AC, added Task 2.0 for broken tests, clarified Task 1.1 warning | Product Owner |
| 2025-12-10 | 0.3 | **Major rewrite:** Migrated from Karma/Jasmine to Vitest, added Task 7 for docs update | Product Owner |
| 2025-12-10 | 0.4 | Added Task 2.5 for Vitest resource config (maxWorkers, pool, fileParallelism) to prevent CPU/memory exhaustion | Product Owner |
| 2025-12-10 | 1.0 | **APPROVED** - Story validated and ready for implementation | Product Owner |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
