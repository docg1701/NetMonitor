# Story 2.2: Theme Toggle & Persistence

## Status
Approved

## Story
**As a** User,
**I want** the application to respect my system's theme preference by default and allow me to override it,
**so that** I can customize the viewing experience or have it match my environment automatically.

## Acceptance Criteria
1. **System Preference Fallback**: On app launch, if no user preference is saved, the application defaults to the OS/System theme (Light or Dark).
2. **System Preference Listener**: If the user has *not* explicitly set a preference, the app updates automatically when the OS theme changes.
3. **Manual Override**: The existing toggle button allows the user to explicitly switch themes (Light/Dark).
4. **Persistence**: The manual selection is saved to `localStorage` and respected on next launch (overriding OS preference).
5. **Visual Consistency**: Chart colors and UI elements remain legible and consistent during all automatic or manual switches.

## Tasks / Subtasks
- [ ] Implement System Preference Detection (AC: 1)
    - [ ] Update `ngOnInit` in `home.page.ts` to check `window.matchMedia('(prefers-color-scheme: dark)')` when no local storage value exists.
- [ ] Implement System Preference Listener (AC: 2)
    - [ ] Add a listener to the media query to update the theme dynamically if `localStorage` is empty.
- [ ] Verify/Refine Persistence Logic (AC: 3, 4)
    - [ ] Ensure `toggleTheme` sets the preference.
    - [ ] Consider adding a "Reset to System" option (Optional, but good for "un-setting" preference. For now, just ensuring fallback works if storage is cleared is enough, or maybe the toggle loops? No, simple toggle is fine. Just ensure the *initial* load handles the "null" case correctly).
- [ ] Verify Chart Updates (AC: 5)
    - [ ] Ensure `updateChartTheme` is called when system theme changes (if following system).

## Dev Notes
**Context:**
Story 2.1 implemented the basic toggle and persistence, but it defaults to Light mode if no preference is found, ignoring the OS setting. This story completes the feature by adding OS awareness.

**File Locations:**
- **Home Logic:** `netmonitor/src/app/home/home.page.ts` [Source: Story 2.1 Record]

**Technical Details:**
- **Media Query:** Use `window.matchMedia('(prefers-color-scheme: dark)')`.
- **Logic Flow:**
    1. Check `localStorage`.
    2. If value exists -> Use it.
    3. If NO value -> Use `mediaQuery.matches`.
    4. Store `mediaQuery` listener to handle runtime system changes (only if no local preference is set).
- **Chart Updates:** The `updateChartTheme` method relies on computed styles. Ensure it runs after the class list is updated.
- **Performance:** Ensure that `updateChartTheme` and any subsequent `chart.update()` calls are handled efficiently to avoid UI stutter during theme switches, especially if triggered by rapid system preference changes (though rare).

**Project Structure Alignment:**
- Modifying existing file `netmonitor/src/app/home/home.page.ts`.

**Testing Requirements:**
- **Unit Tests:** Mock `window.matchMedia` in `home.page.spec.ts` to verify logic.
- **Manual Verification:**
    1. Clear Local Storage.
    2. Set OS to Dark -> App should be Dark.
    3. Set OS to Light -> App should be Light.
    4. Toggle switch -> App changes and saves preference.
    5. Reload -> Saved preference persists, ignoring OS.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-06 | 1.0 | Initial Draft | PO |
| 2025-12-06 | 1.1 | Added performance note and Approved | PO |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
_TBD_